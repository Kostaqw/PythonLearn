<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://kit.fontawesome.com/c2c8ebeca3.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="js/slick-1.8.1/slick/slick.css" />
    <title>Пользователь</title>
</head>

<body>
    <div id="toTop"><i class="fas fa-chevron-up"></i></div>
    <header class="menu-bar">
        <div class="container">
            <div class="row">
                <div class="col-xl-1 logo-bar">
                    <img src="img/logo.png" alt="Main logo" class="logo">
                    <button class="menu-icon">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <div class="col-xl-9 ml-auto align-self-center">
                    <nav>
                        <ul class="menu d-flex justify-content-end">
                            <li class="menu__item"><a href="index.html"><i class="fas fa-home"></i></a></li>
                            <li class="menu__item"><a href="#about">About</a></li>
                            <li class="menu__item"><a href="#service">Servicing</a></li>
                            <li class="menu__item"><a href="#portfolio">Portfolio</a></li>
                            <li class="menu__item"><a href="#blog">Blog</a></li>
                            <li class="menu__item"><a href="#contact">Contact us</a></li>
                            <li class="menu__item"><i class="fa-solid fa-magnifying-glass"></i></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <header class="user_card_header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-xl-10 ">
                    <p class="usercard__text">Конвертация MIDI-времени в такты и доли</p>
                </div>
            </div>
        </div>
    </header>

    <section class="articles">
        <div class="container ">
            <div class="article ">
                <div class="row clearfix">
                    <div class="col-xl-1 ">
                        <img class="articles_avatar" src="img/card/test.png">
                    </div>
                    <div class="col-xl-2">
                        <p class="article_author">
                            kostaqw <br>
                            12.02.2023 г.
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xl-10 tag">
                        <span>
                            <a href="#">Программирование</a>
                        </span>
                        <span>
                            <a href="#">.Net</a>
                        </span>
                        <span>
                            <a href="#">C#</a>
                        </span>
                    </div>
                </div>

                <div class="row article__content">
                    <div class="col-xl-10">
                        <img src="img/card/articleImage.png" alt="">
                    </div>
                </div>
                <div class="row article__content">
                    <div class="col-xl-10">
                        <p>Представьте: вы создаёте новый шедевр в любимой DAW, вставляете в проект MIDI-файл, редактор показывает, что ноты в нём имеют восьмую длительность. Не обращая на это внимания, вы продолжаете творить. Но, постойте. А как DAW, собственно, понимает, что ноты в файле восьмые? В статье попробуем разобраться, как времена в MIDI-файле соотносятся с главным форматом времени при работе с музыкой – тактами и долями. Результатом наших исследований будет законченный алгоритм на C#.</p>
                        <br>
                        <p>В статье попробуем разобраться, как времена в MIDI-файле соотносятся с главным форматом времени при работе с музыкой – тактами и долями. Результатом наших исследований будет законченный алгоритм на C#.</p>
                    </div>
                </div>
                <div class="row article__content justify-content-center">
                    <div class="col-xl-4 ">
                        <hr>
                    </div>
                </div>

                <div class="row article__content">
                    <div class="col-xl-10">
                        <p>План повествования будет таким: определимся с терминологией, посмотрим на варианты решения задачи некоторыми DAW, а затем реализуем логику преобразования времени. Если хочется сразу увидеть финальный код, можно перейти к разделу Заключение.</p>
                    </div>
                </div>

                <div class="row article__content">
                    <div class="col-xl-10">
                        <h3>Содержание</h3>
                        <ul>
                            <li><a href="#">Необходимая теория</a></li>
                            <li><a href="#">Так что с тактами и долями?</a></li>
                            <li><a href="#">Всё сложнее</a></li>
                            <li><a href="#">Пишем код</a></li>
                            <li><a href="#">Заключение</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3>Необходимая теория</h3>
                        <p>
                            Для начала немного сведений о формате MIDI-файлов. Я кратко изложу только то, что нам потребуется далее в статье. Те же из вас, кто хочет скоротать вечер за чтением технических спецификаций, всегда могут обратиться к полному документу на сайте midi.org (для скачивания нужна регистрация).

                            MIDI-файл состоит из блоков, в каждом из которых в хронологическом порядке записана последовательность MIDI-событий (например, взятие ноты или изменение контроллера). Каждое из них снабжено временем относительно предыдущего события – delta-time. Дельты измеряются в тиках (ticks) и представляют собой неотрицательные целые числа.
                            
                            Например, дельта 20 говорит о том, что событие отстоит от предыдущего во времени на 20. Но на 20 чего? Значение этих чисел задаётся структурой в заголовке MIDI-файла, которая, согласно спецификации, называется division (тип деления времени). Эта структура содержит информацию о формате времени в файле, и в 99.(9)% случаев в ней будет записано количество тиков на четвертную ноту (по правде говоря, второй формат – MIDI time code / SMPTE – мне ни разу не встречался). Этот параметр мы будем обозначать далее ticksPerQuarterNote.
                        </p>
                        <h3>Так что с тактами и долями?</h3>
                        <p>
                            Имея на руках вышеуказанную теорию, конвертация времени и длины из тиков в такты (bars) и доли (beats) выглядит делом нехитрым. Размер (time signature) композиции определяется числителем numerator и знаменателем denominator. Например, в вальсовом размере 3/4 имеем numerator = 3, а denominator = 4. Длина тактовой доли 1/denominator в тиках вычисляется из пропорции:
                        </p>
<p class="code">
        1/4 = ticksPerQuarterNote
        1/denominator = beatLength
</p>
                        <p>
                                Таким образом, метод вычисления beatLength будет таким:
                        </p>
<p class="code">
        private static int GetBeatLength(int denominator, int ticksPerQuarterNote) =>
        4 * ticksPerQuarterNote / denominator;
</p>
                        <p>
                                Умножив на numerator, получим длину такта:
                        </p>
<p class="code">
        private static int GetBarLength(int numerator, int denominator, int ticksPerQuarterNote) =>
        numerator * GetBeatLength(denominator, ticksPerQuarterNote);
</p>
                        <p>
                                Зная длины такта и тактовой доли, перевести количество тиков ticks в количество тактов и долей можно простейшим жадным алгоритмом:

                                    разделив ticks на длину такта (barLength), получим количество целых тактов;

                                    взяв остаток от предыдущего деления и разделив его на beatLength, получим количество целых долей;

                                    остаток от предыдущего деления равен оставшимся тикам.

                                На C# соответствующий метод будет выглядеть как-то так:
                        </p>
<p class="code">
    private static (long Bars, long Beats, long Ticks) ConvertToBarsBeatsTicks(
        long ticks,
        int numerator,
        int denominator,
        int ticksPerQuarterNote)
    {
        if (ticks == 0)
            return (0, 0, 0);

        var barLength = GetBarLength(numerator, denominator, ticksPerQuarterNote);
        var bars = Math.DivRem(ticks, barLength, out ticks);

        var beatLength = GetBeatLength(denominator, ticksPerQuarterNote);
        var beats = Math.DivRem(ticks, beatLength, out ticks);

        return (bars, beats, ticks);
    }
</p>
                        <p>
                                Но прежде, чем мы проверим нашу логику, давайте взглянем, как разные DAW справляются с задачей. Я подготовил файл 1B_1b_1s.mid с одной нотой внутри:
                        </p>
                    </div>
                    <div>
                        <img src="img/card/articleImage.png" alt="">
                    </div>

                    <div>
                        <h3>Необходимая теория</h3>
                        <p>
                            Для начала немного сведений о формате MIDI-файлов. Я кратко изложу только то, что нам потребуется далее в статье. Те же из вас, кто хочет скоротать вечер за чтением технических спецификаций, всегда могут обратиться к полному документу на сайте midi.org (для скачивания нужна регистрация).

                            MIDI-файл состоит из блоков, в каждом из которых в хронологическом порядке записана последовательность MIDI-событий (например, взятие ноты или изменение контроллера). Каждое из них снабжено временем относительно предыдущего события – delta-time. Дельты измеряются в тиках (ticks) и представляют собой неотрицательные целые числа.
                            
                            Например, дельта 20 говорит о том, что событие отстоит от предыдущего во времени на 20. Но на 20 чего? Значение этих чисел задаётся структурой в заголовке MIDI-файла, которая, согласно спецификации, называется division (тип деления времени). Эта структура содержит информацию о формате времени в файле, и в 99.(9)% случаев в ней будет записано количество тиков на четвертную ноту (по правде говоря, второй формат – MIDI time code / SMPTE – мне ни разу не встречался). Этот параметр мы будем обозначать далее ticksPerQuarterNote.
                        </p>
                        <h3>Так что с тактами и долями?</h3>
                        <p>
                            Имея на руках вышеуказанную теорию, конвертация времени и длины из тиков в такты (bars) и доли (beats) выглядит делом нехитрым. Размер (time signature) композиции определяется числителем numerator и знаменателем denominator. Например, в вальсовом размере 3/4 имеем numerator = 3, а denominator = 4. Длина тактовой доли 1/denominator в тиках вычисляется из пропорции:
                        </p>
<p class="code">
        1/4 = ticksPerQuarterNote
        1/denominator = beatLength
</p>
                        <p>
                                Таким образом, метод вычисления beatLength будет таким:
                        </p>
<p class="code">
        private static int GetBeatLength(int denominator, int ticksPerQuarterNote) =>
        4 * ticksPerQuarterNote / denominator;
</p>
                        <p>
                                Умножив на numerator, получим длину такта:
                        </p>
<p class="code">
        private static int GetBarLength(int numerator, int denominator, int ticksPerQuarterNote) =>
        numerator * GetBeatLength(denominator, ticksPerQuarterNote);
</p>
                        <p>
                                Зная длины такта и тактовой доли, перевести количество тиков ticks в количество тактов и долей можно простейшим жадным алгоритмом:

                                    разделив ticks на длину такта (barLength), получим количество целых тактов;

                                    взяв остаток от предыдущего деления и разделив его на beatLength, получим количество целых долей;

                                    остаток от предыдущего деления равен оставшимся тикам.

                                На C# соответствующий метод будет выглядеть как-то так:
                        </p>
    <p class="code">
        private static (long Bars, long Beats, long Ticks) ConvertToBarsBeatsTicks(
            long ticks,
            int numerator,
            int denominator,
            int ticksPerQuarterNote)
        {
            if (ticks == 0)
                return (0, 0, 0);

            var barLength = GetBarLength(numerator, denominator, ticksPerQuarterNote);
            var bars = Math.DivRem(ticks, barLength, out ticks);

            var beatLength = GetBeatLength(denominator, ticksPerQuarterNote);
            var beats = Math.DivRem(ticks, beatLength, out ticks);

            return (bars, beats, ticks);
        }
    </p>
                        <p>
                                Но прежде, чем мы проверим нашу логику, давайте взглянем, как разные DAW справляются с задачей. Я подготовил файл 1B_1b_1s.mid с одной нотой внутри:
                        </p>
                    </div>
                </div>
            </div>
            <div class="comment_header">
                <div class="row article__content">
                    <div class="col-xl-10">
                        <p class="usercard__text">Коментарии</p>
                    </div>
                </div>
            </div>
            <div class="comment">
                <div class="row">
                    <div class="col-xl-5">
                        <img src="img/card/test.png" alt=""> kosta  25.03.2019
                    </div>
                </div>
                <div class="row">
                    <div class="col-xl-10">
                        <p>Не забудьте ещё сделать эту фирменную зарядку из биоразлагаемого за три месяца пластика во славу экологии, ага.</p>
                    </div>
                </div>
            </div>
            
            <div class="comment">
                <div class="row">
                    <div class="col-xl-5">
                        <img src="img/card/test.png" alt=""> kosta  25.03.2019
                    </div>
                </div>
                <div class="row">
                    <div class="col-xl-10">
                        <p>Не забудьте ещё сделать эту фирменную зарядку из биоразлагаемого за три месяца пластика во славу экологии, ага.</p>
                    </div>
                </div>
            </div>

            <div class="comment">
                <div class="row">
                    <div class="col-xl-5">
                        <img src="img/card/test.png" alt=""> kosta  25.03.2019
                    </div>
                </div>
                <div class="row">
                    <div class="col-xl-10">
                        <p>Не забудьте ещё сделать эту фирменную зарядку из биоразлагаемого за три месяца пластика во славу экологии, ага.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <section class="comment_footer">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-xl-10">
                    <textarea name="" id="" cols="30" rows="10" placeholder="Комментарий"></textarea>
                </div>
                <div class="col-xl-2 offset-xl-5">
                    <button>Комментировать</button>
                </div>     
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"
        integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD"
        crossorigin="anonymous"></script>
    
    <script src="js/jquery-3.6.3.js"></script>
    <script type="text/javascript" src="js/slick-1.8.1/slick/slick.min.js"></script>
    <script src="js/main.js"></script>
    
</body>

</html>